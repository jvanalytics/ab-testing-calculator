{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2>Teste de Significância do Valor Médio</h2>
        <p class="text-muted">Teste z (DP populacional conhecido) ou teste t (DP amostral)</p>
    </div>
</div>

<div class="row mt-4">
    <div class="col-lg-6">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Teste de Significância do Valor Médio</h5>
            </div>
            <div class="card-body">
                {% if error %}
                <div class="alert alert-danger error-message">
                    {{ error }}
                </div>
                {% endif %}

                <form method="POST" id="averageValueForm">
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="known_pop_sd" name="known_pop_sd" {% if
                                known_pop_sd %}checked{% endif %} onchange="toggleSDInputs()">
                            <label class="form-check-label" for="known_pop_sd">
                                Eu conheço o desvio padrão populacional
                            </label>
                        </div>
                        <small class="form-text text-muted">Marque isso se você conhece o desvio padrão verdadeiro da
                            população (use teste z). Deixe desmarcado para usar o desvio padrão amostral (teste
                            t).</small>
                    </div>

                    <h6 class="mt-2 mb-3">Grupo A</h6>
                    <div class="mb-3">
                        <label for="mean_a" class="form-label">Média</label>
                        <input type="number" step="0.01" class="form-control" id="mean_a" name="mean_a"
                            value="{{ mean_a or '' }}" required>
                    </div>
                    <div class="mb-3" id="sd_a_container">
                        <label for="sd_a" class="form-label" id="sd_a_label">Desvio Padrão Amostral</label>
                        <input type="number" step="0.01" class="form-control" id="sd_a" name="sd_a"
                            value="{{ sd_a or '' }}" min="0.01" required>
                        <small class="form-text text-muted" id="sd_a_help">Desvio padrão calculado a partir dos seus
                            dados amostrais</small>
                    </div>
                    <div class="mb-3" id="pop_sd_a_container" style="display: none;">
                        <label for="pop_sd_a" class="form-label">Desvio Padrão Populacional</label>
                        <input type="number" step="0.01" class="form-control" id="pop_sd_a" name="pop_sd_a"
                            value="{{ pop_sd_a or '' }}" min="0.01">
                        <small class="form-text text-muted">O desvio padrão verdadeiro de toda a população (se
                            conhecido)</small>
                    </div>
                    <div class="mb-3">
                        <label for="n_a" class="form-label">Tamanho da Amostra (n)</label>
                        <input type="number" class="form-control" id="n_a" name="n_a" value="{{ n_a or '' }}" min="1"
                            required>
                    </div>

                    <h6 class="mt-4 mb-3">Grupo B</h6>
                    <div class="mb-3">
                        <label for="mean_b" class="form-label">Média</label>
                        <input type="number" step="0.01" class="form-control" id="mean_b" name="mean_b"
                            value="{{ mean_b or '' }}" required>
                    </div>
                    <div class="mb-3" id="sd_b_container">
                        <label for="sd_b" class="form-label" id="sd_b_label">Desvio Padrão Amostral</label>
                        <input type="number" step="0.01" class="form-control" id="sd_b" name="sd_b"
                            value="{{ sd_b or '' }}" min="0.01" required>
                        <small class="form-text text-muted" id="sd_b_help">Desvio padrão calculado a partir dos seus
                            dados amostrais</small>
                    </div>
                    <div class="mb-3" id="pop_sd_b_container" style="display: none;">
                        <label for="pop_sd_b" class="form-label">Desvio Padrão Populacional</label>
                        <input type="number" step="0.01" class="form-control" id="pop_sd_b" name="pop_sd_b"
                            value="{{ pop_sd_b or '' }}" min="0.01">
                        <small class="form-text text-muted">O desvio padrão verdadeiro de toda a população (se
                            conhecido)</small>
                    </div>
                    <div class="mb-3">
                        <label for="n_b" class="form-label">Tamanho da Amostra (n)</label>
                        <input type="number" class="form-control" id="n_b" name="n_b" value="{{ n_b or '' }}" min="1"
                            required>
                    </div>

                    <button type="submit" class="btn btn-primary">Calcular</button>
                    <button type="reset" class="btn btn-secondary">Redefinir</button>
                    <button type="button" class="btn btn-outline-info" onclick="prefillAverageValue()">Preencher com
                        Dados de Exemplo</button>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-6">
        {% if result %}
        <div class="card shadow-sm result-card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">Resultados</h5>
            </div>
            <div class="card-body">
                <table class="table table-bordered">
                    <tr>
                        <td><strong>Diferença de Médias</strong></td>
                        <td>{{ "%.4f"|format(result.mean_diff) }}</td>
                    </tr>
                    {% if result.test_type == 'z-test' %}
                    <tr>
                        <td><strong>Estatística Z</strong></td>
                        <td>{{ "%.4f"|format(result.z_statistic) }}</td>
                    </tr>
                    {% else %}
                    <tr>
                        <td><strong>Estatística t</strong></td>
                        <td>{{ "%.4f"|format(result.t_statistic) }}</td>
                    </tr>
                    <tr>
                        <td><strong>Graus de Liberdade</strong></td>
                        <td>{{ result.degrees_of_freedom }}</td>
                    </tr>
                    {% endif %}
                    <tr>
                        <td><strong>Valor P</strong></td>
                        <td>{{ "%.4f"|format(result.p_value) }}</td>
                    </tr>
                    {% if 'ci_lower' in result %}
                    <tr>
                        <td><strong>Intervalo de Confiança de 95%</strong></td>
                        <td>[{{ "%.4f"|format(result.ci_lower) }}, {{ "%.4f"|format(result.ci_upper) }}]</td>
                    </tr>
                    {% endif %}
                    <tr>
                        <td><strong>{% if result.is_significant %}Significativo{% else %}Não Significativo{% endif
                                %}</strong></td>
                        <td>
                            <span class="badge bg-{{ 'success' if result.is_significant else 'warning' }}">
                                {% if result.is_significant %}Significativo{% else %}Não Significativo{% endif %}
                            </span>
                        </td>
                    </tr>
                </table>
                <div class="alert alert-info mt-3">
                    <strong>Interpretação:</strong> {{ result.interpretation }}
                </div>
                {% if result.note %}
                <div class="alert alert-warning mt-2">
                    <small>{{ result.note }}</small>
                </div>
                {% endif %}

                <div class="mt-4">
                    <h6>Comparação de Distribuições</h6>
                    <canvas id="bellCurveChart" style="max-height: 300px;"></canvas>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function toggleSDInputs() {
        const checkbox = document.getElementById('known_pop_sd');
        const sdAContainer = document.getElementById('sd_a_container');
        const sdBContainer = document.getElementById('sd_b_container');
        const popSDAContainer = document.getElementById('pop_sd_a_container');
        const popSDBContainer = document.getElementById('pop_sd_b_container');
        const sdAInput = document.getElementById('sd_a');
        const sdBInput = document.getElementById('sd_b');
        const popSDAInput = document.getElementById('pop_sd_a');
        const popSDBInput = document.getElementById('pop_sd_b');

        if (checkbox.checked) {
            // Show population SD inputs, hide sample SD inputs
            sdAContainer.style.display = 'none';
            sdBContainer.style.display = 'none';
            popSDAContainer.style.display = 'block';
            popSDBContainer.style.display = 'block';
            sdAInput.removeAttribute('required');
            sdBInput.removeAttribute('required');
            popSDAInput.setAttribute('required', 'required');
            popSDBInput.setAttribute('required', 'required');
        } else {
            // Show sample SD inputs, hide population SD inputs
            sdAContainer.style.display = 'block';
            sdBContainer.style.display = 'block';
            popSDAContainer.style.display = 'none';
            popSDBContainer.style.display = 'none';
            sdAInput.setAttribute('required', 'required');
            sdBInput.setAttribute('required', 'required');
            popSDAInput.removeAttribute('required');
            popSDBInput.removeAttribute('required');
        }
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function () {
        // Set initial state based on checkbox
        const checkbox = document.getElementById('known_pop_sd');
        if (checkbox) {
            toggleSDInputs();
        }
    });

    function prefillAverageValue() {
        document.getElementById('mean_a').value = '100';
        document.getElementById('sd_a').value = '15';
        document.getElementById('n_a').value = '30';
        document.getElementById('mean_b').value = '105';
        document.getElementById('sd_b').value = '15';
        document.getElementById('n_b').value = '30';
        document.getElementById('known_pop_sd').checked = false;
        toggleSDInputs();
    }
</script>
{% if result %}
<script>
    // Generate bell curve data for normal distribution
    function normalDistribution(x, mean, sd) {
        return Math.exp(-0.5 * Math.pow((x - mean) / sd, 2)) / (sd * Math.sqrt(2 * Math.PI));
    }

    // Calculate range for chart
    const meanA = {{ mean_a }};
    {% if known_pop_sd %}
    const sdA = {{ pop_sd_a }};
    {% else %}
    const sdA = {{ sd_a }};
    {% endif %}
    const meanB = {{ mean_b }};
    {% if known_pop_sd %}
    const sdB = {{ pop_sd_b }};
    {% else %}
    const sdB = {{ sd_b }};
    {% endif %}

    const minX = Math.min(meanA - 4 * sdA, meanB - 4 * sdB);
    const maxX = Math.max(meanA + 4 * sdA, meanB + 4 * sdB);
    const step = (maxX - minX) / 200;

    const labels = [];
    const dataA = [];
    const dataB = [];

    for (let x = minX; x <= maxX; x += step) {
        labels.push(x.toFixed(2));
        dataA.push(normalDistribution(x, meanA, sdA));
        dataB.push(normalDistribution(x, meanB, sdB));
    }

    const ctx = document.getElementById('bellCurveChart').getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Grupo A',
                data: dataA,
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.1)',
                tension: 0.4,
                fill: true
            }, {
                label: 'Grupo B',
                data: dataB,
                borderColor: 'rgb(255, 99, 132)',
                backgroundColor: 'rgba(255, 99, 132, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                },
                title: {
                    display: false
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Valor'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Densidade de Probabilidade'
                    },
                    beginAtZero: true
                }
            }
        }
    });
</script>
{% endif %}
{% endblock %}